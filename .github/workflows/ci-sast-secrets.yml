name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "**/*.py"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.toml"
      - "**/*.json"
      - ".github/workflows/ci-sast-secrets.yml"
      - "security/**"
  pull_request:
    paths:
      - "**/*.py"
      - "**/*.yml"
      - "**/*.yaml"
      - "**/*.toml"
      - "**/*.json"
      - ".github/workflows/ci-sast-secrets.yml"
      - "security/**"

permissions:
  contents: read

concurrency:
  group: sast-secrets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast-secrets:
    name: SAST & Secrets Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for Gitleaks

      - name: Create EVIDENCE directory
        run: mkdir -p EVIDENCE/P10

      # ===== SAST with Semgrep =====
      - name: Run Semgrep SAST scan
        uses: docker://returntocorp/semgrep:latest
        with:
          args: >-
            semgrep scan
            --config p/ci
            --config /github/workspace/security/semgrep/rules.yml
            --sarif
            --output /github/workspace/EVIDENCE/P10/semgrep.sarif
            --metrics off
            --error
            /github/workspace
        continue-on-error: true

      - name: Ensure Semgrep report exists
        run: |
          if [ ! -f EVIDENCE/P10/semgrep.sarif ]; then
            echo '{"version": "2.1.0", "$schema": "https://json.schemastore.org/sarif-2.1.0.json", "runs": []}' > EVIDENCE/P10/semgrep.sarif
          fi

      - name: Generate Semgrep Summary
        run: |
          echo "# Semgrep SAST Summary" > EVIDENCE/P10/semgrep_summary.md
          echo "" >> EVIDENCE/P10/semgrep_summary.md
          echo "**Scan Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> EVIDENCE/P10/semgrep_summary.md
          echo "**Repository:** ${{ github.repository }}" >> EVIDENCE/P10/semgrep_summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> EVIDENCE/P10/semgrep_summary.md
          echo "**Commit:** ${{ github.sha }}" >> EVIDENCE/P10/semgrep_summary.md
          echo "" >> EVIDENCE/P10/semgrep_summary.md
          echo "## Configuration" >> EVIDENCE/P10/semgrep_summary.md
          echo "" >> EVIDENCE/P10/semgrep_summary.md
          echo "- **Profiles:** \`p/ci\` (Semgrep CI recommended rules)" >> EVIDENCE/P10/semgrep_summary.md
          echo "- **Custom Rules:** \`security/semgrep/rules.yml\`" >> EVIDENCE/P10/semgrep_summary.md
          echo "" >> EVIDENCE/P10/semgrep_summary.md
          echo "## Findings" >> EVIDENCE/P10/semgrep_summary.md
          echo "" >> EVIDENCE/P10/semgrep_summary.md

          if [ -f EVIDENCE/P10/semgrep.sarif ]; then
            TOTAL=$(jq '[.runs[]?.results // [] | length] | add // 0' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            ERROR=$(jq '[.runs[]?.results[]? | select(.level == "error")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            WARNING=$(jq '[.runs[]?.results[]? | select(.level == "warning")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")
            NOTE=$(jq '[.runs[]?.results[]? | select(.level == "note")] | length' EVIDENCE/P10/semgrep.sarif 2>/dev/null || echo "0")

            echo "| Level | Count |" >> EVIDENCE/P10/semgrep_summary.md
            echo "|-------|-------|" >> EVIDENCE/P10/semgrep_summary.md
            echo "| Error | $ERROR |" >> EVIDENCE/P10/semgrep_summary.md
            echo "| Warning | $WARNING |" >> EVIDENCE/P10/semgrep_summary.md
            echo "| Note | $NOTE |" >> EVIDENCE/P10/semgrep_summary.md
            echo "| **Total** | **$TOTAL** |" >> EVIDENCE/P10/semgrep_summary.md

            if [ "$TOTAL" -gt 0 ]; then
              echo "" >> EVIDENCE/P10/semgrep_summary.md
              echo "### Detailed Findings" >> EVIDENCE/P10/semgrep_summary.md
              echo "" >> EVIDENCE/P10/semgrep_summary.md
              jq -r '.runs[]?.results[]? | "- **\(.ruleId // "unknown")** (\(.level // "unknown")): \(.locations[0]?.physicalLocation?.artifactLocation?.uri // "unknown file"):\(.locations[0]?.physicalLocation?.region?.startLine // "?") - \(.message?.text // "No message")"' \
                EVIDENCE/P10/semgrep.sarif >> EVIDENCE/P10/semgrep_summary.md 2>/dev/null || echo "Error parsing findings." >> EVIDENCE/P10/semgrep_summary.md
            else
              echo "" >> EVIDENCE/P10/semgrep_summary.md
              echo "✅ No issues found by Semgrep." >> EVIDENCE/P10/semgrep_summary.md
            fi
          else
            echo "No scan results available." >> EVIDENCE/P10/semgrep_summary.md
          fi

      # ===== Secrets Scanning with Gitleaks =====
      - name: Run Gitleaks secrets scan
        uses: docker://zricethezav/gitleaks:latest
        with:
          args: >-
            detect
            --no-banner
            --config=/github/workspace/security/.gitleaks.toml
            --source=/github/workspace
            --report-format=json
            --report-path=/github/workspace/EVIDENCE/P10/gitleaks.json
            --exit-code=0
        continue-on-error: true

      - name: Ensure Gitleaks report exists
        run: |
          if [ ! -f EVIDENCE/P10/gitleaks.json ]; then
            echo '[]' > EVIDENCE/P10/gitleaks.json
          fi

      - name: Generate Gitleaks Summary
        run: |
          echo "# Gitleaks Secrets Scan Summary" > EVIDENCE/P10/gitleaks_summary.md
          echo "" >> EVIDENCE/P10/gitleaks_summary.md
          echo "**Scan Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> EVIDENCE/P10/gitleaks_summary.md
          echo "**Repository:** ${{ github.repository }}" >> EVIDENCE/P10/gitleaks_summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> EVIDENCE/P10/gitleaks_summary.md
          echo "**Commit:** ${{ github.sha }}" >> EVIDENCE/P10/gitleaks_summary.md
          echo "" >> EVIDENCE/P10/gitleaks_summary.md
          echo "## Configuration" >> EVIDENCE/P10/gitleaks_summary.md
          echo "" >> EVIDENCE/P10/gitleaks_summary.md
          echo "- **Config:** \`security/.gitleaks.toml\`" >> EVIDENCE/P10/gitleaks_summary.md
          echo "- **Scan Mode:** Working copy (not full history)" >> EVIDENCE/P10/gitleaks_summary.md
          echo "" >> EVIDENCE/P10/gitleaks_summary.md
          echo "## Findings" >> EVIDENCE/P10/gitleaks_summary.md
          echo "" >> EVIDENCE/P10/gitleaks_summary.md

          if [ -f EVIDENCE/P10/gitleaks.json ]; then
            TOTAL=$(jq 'length' EVIDENCE/P10/gitleaks.json 2>/dev/null || echo "0")

            if [ "$TOTAL" -gt 0 ]; then
              echo "⚠️ **$TOTAL potential secret(s) detected!**" >> EVIDENCE/P10/gitleaks_summary.md
              echo "" >> EVIDENCE/P10/gitleaks_summary.md
              echo "### Detected Secrets" >> EVIDENCE/P10/gitleaks_summary.md
              echo "" >> EVIDENCE/P10/gitleaks_summary.md
              echo "| File | Rule | Line | Description |" >> EVIDENCE/P10/gitleaks_summary.md
              echo "|------|------|------|-------------|" >> EVIDENCE/P10/gitleaks_summary.md
              jq -r '.[] | "| \(.File // "N/A") | \(.RuleID // "N/A") | \(.StartLine // "N/A") | \(.Description // "N/A") |"' \
                EVIDENCE/P10/gitleaks.json >> EVIDENCE/P10/gitleaks_summary.md 2>/dev/null || echo "Error parsing findings." >> EVIDENCE/P10/gitleaks_summary.md
              echo "" >> EVIDENCE/P10/gitleaks_summary.md
              echo "### Action Required" >> EVIDENCE/P10/gitleaks_summary.md
              echo "" >> EVIDENCE/P10/gitleaks_summary.md
              echo "1. Review each finding to determine if it's a real secret or false positive" >> EVIDENCE/P10/gitleaks_summary.md
              echo "2. For real secrets: Remove from code and rotate immediately" >> EVIDENCE/P10/gitleaks_summary.md
              echo "3. For false positives: Add to allowlist in \`security/.gitleaks.toml\`" >> EVIDENCE/P10/gitleaks_summary.md
            else
              echo "✅ No secrets detected by Gitleaks." >> EVIDENCE/P10/gitleaks_summary.md
            fi
          else
            echo "No scan results available." >> EVIDENCE/P10/gitleaks_summary.md
          fi

      - name: Display Summaries
        run: |
          echo "========== SEMGREP SUMMARY =========="
          cat EVIDENCE/P10/semgrep_summary.md
          echo ""
          echo "========== GITLEAKS SUMMARY =========="
          cat EVIDENCE/P10/gitleaks_summary.md

      - name: Upload SAST & Secrets Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast-secrets-reports
          path: |
            EVIDENCE/P10/semgrep.sarif
            EVIDENCE/P10/semgrep_summary.md
            EVIDENCE/P10/gitleaks.json
            EVIDENCE/P10/gitleaks_summary.md
          retention-days: 30
