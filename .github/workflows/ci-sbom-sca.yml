name: Security - SBOM & SCA

on:
  workflow_dispatch:
  push:
    paths:
      - "requirements*.txt"
      - "**/*.py"
      - ".github/workflows/ci-sbom-sca.yml"
  pull_request:
    paths:
      - "requirements*.txt"
      - "**/*.py"
      - ".github/workflows/ci-sbom-sca.yml"

permissions:
  contents: read

jobs:
  sbom-sca:
    name: SBOM & SCA Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create EVIDENCE directory
        run: mkdir -p EVIDENCE/P09

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0.17.8
        with:
          path: .
          format: cyclonedx-json
          output-file: EVIDENCE/P09/sbom.json

      - name: Run Grype SCA scan
        uses: anchore/scan-action@v5.3.0
        id: grype-scan
        with:
          sbom: EVIDENCE/P09/sbom.json
          output-format: json
          fail-build: false
        continue-on-error: true

      - name: Save Grype report
        run: |
          if [ -f "${{ steps.grype-scan.outputs.json }}" ]; then
            cp "${{ steps.grype-scan.outputs.json }}" EVIDENCE/P09/sca_report.json
          else
            echo '{"matches": [], "error": "Grype scan did not produce output"}' > EVIDENCE/P09/sca_report.json
          fi

      - name: Generate SCA Summary
        run: |
          echo "# SCA Vulnerability Summary" > EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "**Scan Date:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> EVIDENCE/P09/sca_summary.md
          echo "**Repository:** ${{ github.repository }}" >> EVIDENCE/P09/sca_summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> EVIDENCE/P09/sca_summary.md
          echo "**Commit:** ${{ github.sha }}" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md
          echo "## Vulnerability Counts by Severity" >> EVIDENCE/P09/sca_summary.md
          echo "" >> EVIDENCE/P09/sca_summary.md

          if [ -f EVIDENCE/P09/sca_report.json ]; then
            echo '```json' >> EVIDENCE/P09/sca_summary.md
            jq '[.matches[]?.vulnerability.severity // empty] | group_by(.) | map({(.[0]): length}) | add // {}' \
              EVIDENCE/P09/sca_report.json >> EVIDENCE/P09/sca_summary.md 2>/dev/null || echo '{}' >> EVIDENCE/P09/sca_summary.md
            echo '```' >> EVIDENCE/P09/sca_summary.md

            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "## Detailed Findings" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md

            TOTAL=$(jq '.matches | length' EVIDENCE/P09/sca_report.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.matches[]? | select(.vulnerability.severity == "Critical")] | length' EVIDENCE/P09/sca_report.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.matches[]? | select(.vulnerability.severity == "High")] | length' EVIDENCE/P09/sca_report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.matches[]? | select(.vulnerability.severity == "Medium")] | length' EVIDENCE/P09/sca_report.json 2>/dev/null || echo "0")
            LOW=$(jq '[.matches[]? | select(.vulnerability.severity == "Low")] | length' EVIDENCE/P09/sca_report.json 2>/dev/null || echo "0")

            echo "| Severity | Count |" >> EVIDENCE/P09/sca_summary.md
            echo "|----------|-------|" >> EVIDENCE/P09/sca_summary.md
            echo "| Critical | $CRITICAL |" >> EVIDENCE/P09/sca_summary.md
            echo "| High | $HIGH |" >> EVIDENCE/P09/sca_summary.md
            echo "| Medium | $MEDIUM |" >> EVIDENCE/P09/sca_summary.md
            echo "| Low | $LOW |" >> EVIDENCE/P09/sca_summary.md
            echo "| **Total** | **$TOTAL** |" >> EVIDENCE/P09/sca_summary.md

            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "## Critical & High Vulnerabilities" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              jq -r '.matches[] | select(.vulnerability.severity == "Critical" or .vulnerability.severity == "High") | "- **\(.vulnerability.id)** (\(.vulnerability.severity)): \(.artifact.name)@\(.artifact.version) - \(.vulnerability.description // "No description")[.\(.vulnerability.dataSource // "")]"' \
                EVIDENCE/P09/sca_report.json >> EVIDENCE/P09/sca_summary.md 2>/dev/null || echo "Error parsing vulnerabilities." >> EVIDENCE/P09/sca_summary.md
            else
              echo "âœ… No Critical or High vulnerabilities found." >> EVIDENCE/P09/sca_summary.md
            fi

            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "## Action Plan" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "| Priority | Action |" >> EVIDENCE/P09/sca_summary.md
            echo "|----------|--------|" >> EVIDENCE/P09/sca_summary.md
            if [ "$CRITICAL" -gt 0 ]; then
              echo "| ðŸ”´ Critical | Immediate fix required (SLA: 7 days) |" >> EVIDENCE/P09/sca_summary.md
            fi
            if [ "$HIGH" -gt 0 ]; then
              echo "| ðŸŸ  High | Fix within 30 days or add waiver to \`policy/waivers.yml\` |" >> EVIDENCE/P09/sca_summary.md
            fi
            if [ "$MEDIUM" -gt 0 ]; then
              echo "| ðŸŸ¡ Medium | Review and plan fix within 90 days |" >> EVIDENCE/P09/sca_summary.md
            fi
            if [ "$CRITICAL" -eq 0 ] && [ "$HIGH" -eq 0 ] && [ "$MEDIUM" -eq 0 ]; then
              echo "| âœ… None | No immediate action required |" >> EVIDENCE/P09/sca_summary.md
            fi

            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "## Notes" >> EVIDENCE/P09/sca_summary.md
            echo "" >> EVIDENCE/P09/sca_summary.md
            echo "- SBOM generated using Syft v0.17.8 (CycloneDX JSON format)" >> EVIDENCE/P09/sca_summary.md
            echo "- SCA scan performed using Grype v5.3.0" >> EVIDENCE/P09/sca_summary.md
            echo "- Waivers policy: see \`policy/waivers.yml\`" >> EVIDENCE/P09/sca_summary.md
            echo "- Full report: \`EVIDENCE/P09/sca_report.json\`" >> EVIDENCE/P09/sca_summary.md
          else
            echo "No scan results available." >> EVIDENCE/P09/sca_summary.md
          fi

      - name: Display SCA Summary
        run: cat EVIDENCE/P09/sca_summary.md

      - name: Upload SBOM & SCA Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-sca-reports
          path: |
            EVIDENCE/P09/sbom.json
            EVIDENCE/P09/sca_report.json
            EVIDENCE/P09/sca_summary.md
          retention-days: 30
