# P12 - IaC & Container Security Workflow
# Runs Hadolint, Checkov, and Trivy scans on Dockerfile and IaC manifests

name: Security - IaC & Container (P12)

on:
  push:
    branches:
      - main
      - 'p12-*'
    paths:
      - 'Dockerfile'
      - 'docker-compose.yaml'
      - 'iac/**'
      - 'security/hadolint.yaml'
      - 'security/checkov.yaml'
      - 'security/trivy.yaml'
      - '.github/workflows/ci-p12-iac-container.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - 'docker-compose.yaml'
      - 'iac/**'
      - 'security/hadolint.yaml'
      - 'security/checkov.yaml'
      - 'security/trivy.yaml'
      - '.github/workflows/ci-p12-iac-container.yml'
  workflow_dispatch:
    inputs:
      run_all_scans:
        description: 'Run all security scans'
        required: false
        default: 'true'
        type: boolean

# Prevent duplicate runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: secdev-course-app
  IMAGE_TAG: local-${{ github.sha }}

jobs:
  # Job 1: Hadolint - Dockerfile linting
  hadolint:
    name: Hadolint - Dockerfile Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create EVIDENCE directory
        run: mkdir -p EVIDENCE/P12

      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          config: security/hadolint.yaml
          format: json
          output-file: EVIDENCE/P12/hadolint_report.json
          failure-threshold: error
          no-fail: true

      - name: Display Hadolint results
        if: always()
        run: |
          echo "=== Hadolint Results ==="
          if [ -f EVIDENCE/P12/hadolint_report.json ]; then
            cat EVIDENCE/P12/hadolint_report.json | jq '.' || cat EVIDENCE/P12/hadolint_report.json
          else
            echo "No report file generated"
          fi

      - name: Upload Hadolint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hadolint-report
          path: EVIDENCE/P12/hadolint_report.json
          retention-days: 30

  # Job 2: Checkov - IaC security scanning
  checkov:
    name: Checkov - IaC Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create EVIDENCE directory
        run: mkdir -p EVIDENCE/P12

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov on IaC directory
        run: |
          checkov \
            --directory iac/ \
            --framework kubernetes \
            --output json \
            --output-file-path EVIDENCE/P12 \
            --soft-fail \
            --compact \
            --download-external-modules false
          # Rename output file
          if [ -f EVIDENCE/P12/results_json.json ]; then
            mv EVIDENCE/P12/results_json.json EVIDENCE/P12/checkov_iac_report.json
          fi

      - name: Run Checkov on Dockerfile
        run: |
          checkov \
            --file Dockerfile \
            --framework dockerfile \
            --output json \
            --output-file-path EVIDENCE/P12 \
            --soft-fail \
            --compact
          # Rename output file
          if [ -f EVIDENCE/P12/results_json.json ]; then
            mv EVIDENCE/P12/results_json.json EVIDENCE/P12/checkov_dockerfile_report.json
          fi

      - name: Run Checkov on docker-compose
        run: |
          checkov \
            --file docker-compose.yaml \
            --framework docker_compose \
            --output json \
            --output-file-path EVIDENCE/P12 \
            --soft-fail \
            --compact
          # Rename output file
          if [ -f EVIDENCE/P12/results_json.json ]; then
            mv EVIDENCE/P12/results_json.json EVIDENCE/P12/checkov_compose_report.json
          fi

      - name: Merge Checkov reports
        run: |
          echo '{"iac": ' > EVIDENCE/P12/checkov_report.json
          cat EVIDENCE/P12/checkov_iac_report.json >> EVIDENCE/P12/checkov_report.json || echo '{}' >> EVIDENCE/P12/checkov_report.json
          echo ', "dockerfile": ' >> EVIDENCE/P12/checkov_report.json
          cat EVIDENCE/P12/checkov_dockerfile_report.json >> EVIDENCE/P12/checkov_report.json || echo '{}' >> EVIDENCE/P12/checkov_report.json
          echo ', "docker_compose": ' >> EVIDENCE/P12/checkov_report.json
          cat EVIDENCE/P12/checkov_compose_report.json >> EVIDENCE/P12/checkov_report.json || echo '{}' >> EVIDENCE/P12/checkov_report.json
          echo '}' >> EVIDENCE/P12/checkov_report.json

      - name: Display Checkov summary
        if: always()
        run: |
          echo "=== Checkov Results Summary ==="
          echo "--- IaC Results ---"
          if [ -f EVIDENCE/P12/checkov_iac_report.json ]; then
            cat EVIDENCE/P12/checkov_iac_report.json | jq '.summary // .' || cat EVIDENCE/P12/checkov_iac_report.json
          fi
          echo "--- Dockerfile Results ---"
          if [ -f EVIDENCE/P12/checkov_dockerfile_report.json ]; then
            cat EVIDENCE/P12/checkov_dockerfile_report.json | jq '.summary // .' || cat EVIDENCE/P12/checkov_dockerfile_report.json
          fi

      - name: Upload Checkov reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: checkov-reports
          path: |
            EVIDENCE/P12/checkov_report.json
            EVIDENCE/P12/checkov_iac_report.json
            EVIDENCE/P12/checkov_dockerfile_report.json
            EVIDENCE/P12/checkov_compose_report.json
          retention-days: 30

  # Job 3: Trivy - Container image scanning
  trivy:
    name: Trivy - Container Image Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create EVIDENCE directory
        run: mkdir -p EVIDENCE/P12

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: '${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}'
          format: 'json'
          output: 'EVIDENCE/P12/trivy_report.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          vuln-type: 'os,library'
          scanners: 'vuln,secret,misconfig'
          exit-code: '0'
          ignore-unfixed: false
          timeout: '10m'

      - name: Run Trivy for SARIF output
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: '${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}'
          format: 'sarif'
          output: 'EVIDENCE/P12/trivy_report.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Display Trivy summary
        if: always()
        run: |
          echo "=== Trivy Results Summary ==="
          if [ -f EVIDENCE/P12/trivy_report.json ]; then
            echo "Vulnerabilities found:"
            cat EVIDENCE/P12/trivy_report.json | jq '[.Results[]?.Vulnerabilities // [] | length] | add // 0' || echo "Unable to parse"
            echo ""
            echo "Critical/High vulnerabilities:"
            cat EVIDENCE/P12/trivy_report.json | jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL" or .Severity == "HIGH")] | length' || echo "Unable to parse"
          fi

      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            EVIDENCE/P12/trivy_report.json
            EVIDENCE/P12/trivy_report.sarif
          retention-days: 30

      - name: Upload Trivy SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'EVIDENCE/P12/trivy_report.sarif'
          category: 'trivy-container'
        continue-on-error: true

  # Job 4: Aggregate all reports
  aggregate-reports:
    name: Aggregate P12 Evidence
    runs-on: ubuntu-latest
    needs: [hadolint, checkov, trivy]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create EVIDENCE directory
        run: mkdir -p EVIDENCE/P12

      - name: Download Hadolint report
        uses: actions/download-artifact@v4
        with:
          name: hadolint-report
          path: EVIDENCE/P12/
        continue-on-error: true

      - name: Download Checkov reports
        uses: actions/download-artifact@v4
        with:
          name: checkov-reports
          path: EVIDENCE/P12/
        continue-on-error: true

      - name: Download Trivy reports
        uses: actions/download-artifact@v4
        with:
          name: trivy-reports
          path: EVIDENCE/P12/
        continue-on-error: true

      - name: Generate summary report
        run: |
          echo "# P12 - IaC & Container Security Evidence" > EVIDENCE/P12/summary.md
          echo "" >> EVIDENCE/P12/summary.md
          echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> EVIDENCE/P12/summary.md
          echo "**Commit:** ${{ github.sha }}" >> EVIDENCE/P12/summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> EVIDENCE/P12/summary.md
          echo "" >> EVIDENCE/P12/summary.md

          echo "## Reports Generated" >> EVIDENCE/P12/summary.md
          echo "" >> EVIDENCE/P12/summary.md

          if [ -f EVIDENCE/P12/hadolint_report.json ]; then
            echo "- ✅ hadolint_report.json" >> EVIDENCE/P12/summary.md
          else
            echo "- ❌ hadolint_report.json (missing)" >> EVIDENCE/P12/summary.md
          fi

          if [ -f EVIDENCE/P12/checkov_report.json ]; then
            echo "- ✅ checkov_report.json" >> EVIDENCE/P12/summary.md
          else
            echo "- ❌ checkov_report.json (missing)" >> EVIDENCE/P12/summary.md
          fi

          if [ -f EVIDENCE/P12/trivy_report.json ]; then
            echo "- ✅ trivy_report.json" >> EVIDENCE/P12/summary.md
          else
            echo "- ❌ trivy_report.json (missing)" >> EVIDENCE/P12/summary.md
          fi

          echo "" >> EVIDENCE/P12/summary.md
          echo "## Quick Stats" >> EVIDENCE/P12/summary.md
          echo "" >> EVIDENCE/P12/summary.md

          # Hadolint stats
          if [ -f EVIDENCE/P12/hadolint_report.json ]; then
            HADOLINT_ISSUES=$(cat EVIDENCE/P12/hadolint_report.json | jq 'length // 0' 2>/dev/null || echo "N/A")
            echo "- **Hadolint issues:** $HADOLINT_ISSUES" >> EVIDENCE/P12/summary.md
          fi

          # Trivy stats
          if [ -f EVIDENCE/P12/trivy_report.json ]; then
            TRIVY_VULNS=$(cat EVIDENCE/P12/trivy_report.json | jq '[.Results[]?.Vulnerabilities // [] | length] | add // 0' 2>/dev/null || echo "N/A")
            echo "- **Trivy vulnerabilities:** $TRIVY_VULNS" >> EVIDENCE/P12/summary.md
          fi

      - name: Display summary
        run: cat EVIDENCE/P12/summary.md

      - name: Upload aggregated P12 evidence
        uses: actions/upload-artifact@v4
        with:
          name: P12_EVIDENCE
          path: EVIDENCE/P12/
          retention-days: 90
